
#define _SUPPRESS_PLIB_WARNING
#include <plib.h>
#include "composite32-high4.h"
#include "lib_composite32-high.h"

//外付けクリスタル with PLL (15倍)
#pragma config PMDL1WAY = OFF, IOL1WAY = OFF
#pragma config FPLLIDIV = DIV_1, FPLLMUL = MUL_15, FPLLODIV = DIV_1
#pragma config FNOSC = PRIPLL, FSOSCEN = OFF, POSCMOD = XT, OSCIOFNC = OFF
#pragma config FPBDIV = DIV_1, FWDTEN = OFF, JTAGEN = OFF, ICESEL = ICS_PGx1

#define SAMPLING_FREQ 16000
#define OUTPUT_FREQ 100000
#define CLOCK_FREQ 53800000

//sounddata配列　低いド?3オクターブ分の周期カウンタ値、PR3に書き込むと音程設定される
unsigned char sounddata[1024]={130.901693221486,158.778514653942,180.90168791238,195.105643550698,199.999999999995,195.105663747729,180.901726329417,158.778567530459,130.901755381564,100.000065358979,69.0983689386047,41.2215382226007,19.0983505046918,4.89437664637394,0.0000000000480611106468132,4.8943160552801,19.0982352535802,41.2213795930484,69.0981824583711,99.9998692820414,130.901568901291,158.778408900832,180.901611078202,195.105603156514,199.999999999867,195.10570414167,180.901803163388,158.778673283419,130.90187970168,100.000196076938,69.0984932588265,41.2216439757612,19.098427338939,4.89441704063964,0.000000000261650257016299,4.89427566142065,19.0981584196785,41.221273840139,69.0980581382814,99.9997385640828,130.901444581043,158.778303147621,180.901534243885,195.105562762167,199.999999999567,195.105744535448,180.90187999722,158.778779036278,130.902004021744,100.000326794897,69.0986175791013,41.2217497290221,19.0985041733246,4.89445743506778,0.000000000646110720481374,4.89423526772374,19.0980815859152,41.2211680873301,69.0979338182443,99.999607846124,130.901320260742,158.77819739431,180.901457409431,195.105522367657,199.999999999098,195.105784929064,180.901956830915,158.778884789037,130.902128341754,100.000457512855,69.0987418994285,41.2218554823836,19.0985810078483,4.89449782965853,0.00000000120144250104204,4.8941948741894,19.0980047522899,41.2210623346217,69.0978094982603,99.9994771281655,130.901195940388,158.778091640898,180.901380574838,195.105481972985,199.999999998457,195.105825322517,180.902033664471,158.778990541695,130.902252661712,100.000588230814,69.0988662198085,41.2219612358452,19.0986578425101,4.8945382244117,0.00000000192764559869829,4.89415448081756,19.0979279188028,41.2209565820132,69.0976851783287,99.9993464102068,130.901071619981,158.777985887386,180.901303740107,195.105441578151,199.999999997645,195.105865715808,180.902110497889,158.779096294253,130.902376981617,100.000718948772,69.0989905402417,41.2220669894076,19.0987346773102,4.89457861932738,0.00000000282473422430485,4.89411408760812,19.0978510854542,41.2208508295057,69.09756085845,99.999215692248,130.900947299522,158.777880133774,180.901226905238,195.105401183154,199.999999996663,195.105906108936,180.902187331168,158.77920204671,130.902501301469,100.000849666731,69.0991148607276,41.2221727430698,19.0988115122488,4.89461901440566,0.00000000389267995615228,4.89407369456119,19.0977742522441,41.220745077099,69.0974365386241,99.9990849742892,130.90082297901,158.777774380061,180.90115007023,195.105360787994,199.999999995509,195.105946501901,180.90226416431,158.779307799067,130.902625621269,100.00098038469,69.0992391812657,41.222278496833,19.0988883473256,4.89465940964648,0.0000000051314970050953,4.894033301677,19.0976974191717,41.2206393247921,69.0973122188516,99.9989542563311,130.900698658445,158.777668626247,180.901073235084,195.105320392672,199.999999994185,195.105986894704,180.902340997312,158.779413551324,130.902749941015,100.001111102648,69.099363501858,41.2223842506967,19.098965182541,4.89469980504977,0.00000000654118537113391,4.89399290895508,19.0976205862372,41.2205335725856,69.0971878991313,99.998823538373,130.900574337827,158.777562872334,180.9009963998,195.105279997188,199.99999999269,195.106027287345,180.902417830178,158.77951930348,130.902874260709,100.001241820606,69.0994878225016,41.2224900046602,19.0990420178939,4.89474020061559,0.0000000081217450542681,4.89395251639544,19.0975437534418,41.2204278204796,69.0970635794645,99.9986928204135,130.900450017157,158.777457118319,180.900919564378,195.10523960154,199.999999991024,195.106067679823,180.902494662904,158.779625055535,130.902998580349,100.001372538566,69.0996121431981,41.2225957587253,19.099118853385,4.89478059634392,0.00000000987319026535261,4.893912123999,19.0974669207842,41.2203220684746,69.0969392598491,99.9985621024555,130.900325696433,158.777351364205,180.900842728817,195.105199205731,199.999999989187,195.106108072138,180.902571495493,158.77973080749,130.903122899938,100.001503256524,69.0997364639487,41.2227015128897,19.0991956890151,4.89482099223453,0.000000011795492582678,4.89387173176439,19.0973900882652,41.2202163165688,69.0968149402878,99.998431384496,130.900201375657,158.777245609989,180.900765893118,195.105158809759,199.999999987179,195.106148464292,180.902648327942,158.779836559346,130.903247219473,100.001633974483,69.0998607847508,41.2228072671556,19.0992725247827,4.89486138828764,0.0000000138886804279537,4.89383133969274,19.0973132558837,41.2201105647647,69.0966906207781,99.9983006665379,130.900077054827,158.777139855674,180.900689057282,195.105118413625,199.999999985001,195.106188856282,180.902725160255,158.7799423111,130.903371538956,100.001764692441,69.0999851056071,41.2229130215209,19.0993493606884,4.89490178450328,0.0000000161527395903249,4.8937909477836,19.0972364236412,41.2200048130599,69.0965663013224,99.9981699485784,130.899952733946,158.777034101259,180.900612221307,195.105078017328,199.999999982651,195.10622924811,180.902801992428,158.780048062754,130.903495858386,100.001895410401,69.1001094265148,41.2230187759866,19.0994261967325,4.89494218088184,0.0000000185876558589371,4.89375055603652,19.0971595915369,41.2198990614566,69.0964419819183,99.9980392306204,130.899828413012,158.776928346743,180.900535385193,195.105037620868,199.999999980131,195.106269639776,180.902878824464,158.780153814307,130.903620177763,100.002026128359,69.1002337474752,41.2231245305527,19.0995030329156,4.8949825774225,0.0000000211934434446448,4.8937101644524,19.0970827595701,41.2197933099538,69.0963176625683,99.9979085126623,130.899704092025,158.776822592125,180.900458548941,195.104997224246,199.99999997744,195.106310031279,180.902955656361,158.780259565761,130.903744497087,100.002156846317,69.1003580684885,41.2232302852204,19.0995798692369,4.89502297412564,0.0000000239701165583028,4.89366977303034,19.0970059277415,41.2196875585514,69.0961933432711,99.9977777947043,130.899579770984,158.776716837407,180.900381712552,195.104956827461,199.999999974577,195.10635042262,180.90303248812,158.780365317113,130.903868816358,100.002287564276,69.1004823895546,41.2233360399874,19.0996567056957,4.89506337099218,0.0000000269176609890565,4.89362938177123,19.096929096052,41.2195818072483,69.0960690240267,99.9976470767462,130.899455449891,158.77661108259,180.900304876022,195.104916430515,199.999999971545,195.106390813798,180.903109319741,158.780471068365,130.903993135576,100.002418282234,69.1006067106762,41.2234417948548,19.0997335422926,4.89510376802033,0.000000030036062526051,4.89358899067464,19.0968522645007,41.2194760560468,69.0959447048337,99.9975163587882,130.899331128746,158.776505327673,180.900228039356,195.104876033405,199.999999968341,195.106431204813,180.903186151223,158.780576819517,130.904117454741,100.002549000192,69.1007310318478,41.223547549825,19.0998103790278,4.89514416521102,0.0000000333253495909958,4.89354859974011,19.0967754330877,41.2193703049457,69.0958203856949,99.9973856408273,130.899206807548,158.776399572655,180.900151202552,195.104835636132,199.999999964966,195.106471595666,180.903262982567,158.780682570569,130.904241773856,100.002679718152,69.1008553530723,41.2236533048921,19.099887215903,4.89518456256376,0.0000000367855079730361,4.89350820896854,19.0966986018112,41.2192645539451,69.0956960666076,99.9972549228692,130.899082486296,158.776293817536,180.90007436561,195.104795238698,199.99999996142,195.106511986356,180.903339813773,158.78078832152,130.904366092916,100.00281043611,69.1009796743496,41.2237590600608,19.0999640529146,4.89522496008033,0.0000000404165376721721,4.89346781835948,19.0966217706747,41.2191588030426,69.0955717475744,99.9971242049112,130.898958164992,158.776188062315,180.899997528529,195.104754841101,199.999999957704,195.106552376885,180.90341664484,158.78089407237,130.904490411922,100.002941154068,69.1011039956824,41.22386481533,19.1000408900645,4.89526535775852,0.000000044218424477549,4.89342742791293,19.0965449396764,41.2190530522429,69.0954474285941,99.9969934869532,130.898833843636,158.776082306995,180.899920691309,195.104714443341,199.999999953817,195.10659276725,180.903493475771,158.780999823119,130.904614730876,100.003071872026,69.1012283170652,41.2239705707019,19.1001177273527,4.89530575559922,0.0000000481911968108761,4.893387037628,19.0964681088163,41.2189473015435,69.0953231096665,99.9968627689923,130.898709522226,158.775976551576,180.899843853951,195.104674045419,199.999999949758,195.106633157453,180.903570306562,158.781105573768,130.904739049777,100.003202589984,69.1013526385009,41.2240763261719,19.1001945647808,4.89534615360243,0.0000000523348546721536,4.89334664750646,19.0963912780944,41.2188415509447,69.0951987907918,99.9967320510343,130.898585200761,158.775870796055,180.899767016456,195.104633647334,199.999999945529,195.106673547493,180.903647137215,158.781211324317,130.904863368629,100.003333307942,69.1014769599894,41.2241820817423,19.1002714023454,4.89538655176902,0.0000000566493554288172,4.89330625754745,19.0963144475109,41.218735800444,69.0950744719698,99.9966013330763,130.898460879247,158.775765040433,180.899690178822,195.104593249087,199.999999941129,195.106713937371,180.903723967729,158.781317074765,130.904987687424,100.003464025903,69.1016012815306,41.2242878374132,19.1003482400482,4.89542695009725,0.0000000611347417134311,4.89326586775094,19.0962376170655,41.218630050046,69.094950153198,99.9964706151183,130.898336557679,158.775659284711,180.899613341049,195.104552850678,199.999999936558,195.106754327086,180.903800798107,158.781422825113,130.905112006167,100.003594743861,69.1017256031274,41.2243935931845,19.1004250778893,4.89546734858799,0.0000000657909993151407,4.89322547811607,19.0961607867584,41.2185242997484,69.0948258344816,99.9963398971575,130.898212236059,158.77555352889,180.899536503138,195.104512452106,199.999999931817,195.106794716639,180.903877628345,158.781528575363,130.905236324857,100.003725461819,69.1018499247742,41.2244993490585,19.1005019158686,4.89550774724123,0.0000000706181282339458,4.89318508864457,19.0960839565879,41.2184185495513,69.0947015158181,99.9962091791995,130.898087914383,158.775447772968,180.89945966509,195.104472053371,199.999999926904,195.106835106029,180.903954458445,158.78163432551,130.905360643497,100.003856179777,69.1019742464739,41.2246051050307,19.1005787539862,4.89554814605697,0.0000000756161284698464,4.89314469933558,19.0960071265572,41.2183127994524,69.0945771972074,99.9960784612415,130.897963592656,158.775342016946,180.899382826903,195.104431654474,199.999999921821,195.106875495258,180.904031288406,158.781740075556,130.905484962081,100.003986897738,69.1020985682263,41.2247108611033,19.100655592242,4.89558854503609,0.0000000807850000228427,4.89310431018912,19.0959302966649,41.2182070494561,69.0944528786468,99.9959477432835,130.897839270878,158.775236260823,180.899305988577,195.104391255415,199.999999916566,195.106915884323,180.904108118231,158.781845825502,130.905609280612,100.004117615695,69.1022228900316,41.2248166172763,19.100732430636,4.89562894417685,0.0000000861247571037893,4.89306392120515,19.0958534669107,41.2181012995603,69.0943285601417,99.9958170253255,130.897714949046,158.7751305046,180.899229150113,195.104350856192,199.999999911141,195.106956273226,180.904184947916,158.78195157535,130.905733599091,100.004248333653,69.1023472118896,41.2249223735498,19.1008092691683,4.89566934348011,0.0000000916353712909768,4.89302353238284,19.0957766372932,41.217995549765,69.0942042416921,99.9956863073676,130.897590627162,158.775024748276,180.899152311512,195.104310456807,199.999999905545,195.106996661967,180.904261777463,158.782057325093,130.905857917517,100.004379051611,69.1024715338004,41.225028129926,19.1008861078405,4.89570974294676,0.0000000973168567952598,4.89298314372478,19.0956998078172,41.2178898000701,69.09407992329,99.9955555894096,130.897466305222,158.774918991849,180.899075472771,195.104270057259,199.999999899778,195.107037050544,180.904338606871,158.78216307474,130.90598223589,100.004509769572,69.1025958557668,41.2251338864026,19.1009629466475,4.89575014257416,0.000000103169213616638,4.89294275522747,19.0956229784761,41.2177840504757,69.0939556049406,99.9954248714488,130.897341983234,158.774813235327,180.898998633895,195.104229657551,199.999999893841,195.10707743896,180.904415436142,158.782268824286,130.906106554213,100.004640487527,69.1027201777805,41.225239642975,19.1010397855962,4.89579054236583,0.000000109192455965967,4.89290236689355,19.0955461492733,41.2176783009816,69.0938312866494,99.9952941534937,130.897217661189,158.7747074787,180.898921794877,195.104189257678,199.999999887732,195.107117827213,180.904492265274,158.782374573728,130.906230872478,100.004771205488,69.1028444998524,41.2253453996525,19.101116624683,4.89583094231911,0.000000115386555421537,4.89286197872215,19.095469320212,41.2175725515881,69.0937069684057,99.9951634355329,130.897093339091,158.774601721972,180.898844955724,195.104148857644,199.999999881452,195.107158215303,180.904569094268,158.782480323073,130.906355190695,100.004901923449,69.1029688219771,41.2254511564258,19.1011934639048,4.89587134243492,0.000000121751526194203,4.89282159071325,19.0953924912857,41.2174668022927,69.0935826502147,99.9950327175779,130.896969016945,158.774495965149,180.89876811643,195.104108457446,199.999999875002,195.107198603231,180.904645923125,158.782586072314,130.906479508854,100.005032641404,69.1030931441492,41.2255569133042,19.1012703032681,4.89591174271321,0.000000128287382494818,4.892781202866,19.0953156625009,41.2173610531023,69.093458332082,99.9949019996171,130.896844694741,158.77439020822,180.898691276999,195.104068057086,199.999999868381,195.107238990995,180.90472275184,158.782691821459,130.906603826966,100.005163359365,69.1032174663795,41.2256626702806,19.1013471427697,4.89595214315402,0.000000134994095901675,4.892740815183,19.095238833851,41.2172553040077,69.0933340139967,99.9947712816564,130.896720372487,158.774284451196,180.89861443743,195.104027656565,199.999999861588,195.107279378599,180.904799580421,158.782797570503,130.906728145025,100.00529407732,69.1033417886572,41.2257684273575,19.1014239824061,4.89599254375733,0.000000141871694836482,4.89270042765989,19.0951620053394,41.2171495550136,69.0932096959723,99.9946405636985,130.89659605018,158.774178694066,180.898537597723,195.10398725588,199.999999854625,195.10731976604,180.90487640886,158.78290331944,130.906852463028,100.005424795281,69.1034661109931,41.2258741845349,19.1015008221825,4.89603294452492,0.00000014892015087753,4.89266004030281,19.095085176971,41.2170438061223,69.0930853779899,99.9945098457406,130.896471727821,158.774072936839,180.898460757874,195.103946855033,199.999999847492,195.107360153316,180.904953237166,158.783009068286,130.906976780979,100.005555513238,69.1035904333791,41.2259799418126,19.1015776620971,4.89607334545148,0.000000156139492446528,4.89261965310472,19.0950083487342,41.2169380573314,69.0929610600657,99.9943791277827,130.896347405408,158.773967179511,180.898383917894,195.103906454023,199.999999840187,195.107400540433,180.905030065331,158.783114817026,130.907101098877,100.005686231196,69.1037147558179,41.2260856991908,19.1016545021499,4.89611374654407,0.000000163529705332621,4.8925792660709,19.094931520639,41.2168323086409,69.0928367421944,99.9942484098248,130.896223082943,158.773861422082,180.898307077768,195.10386605285,199.999999832711,195.107440927383,180.905106893357,158.783220565667,130.907225416722,100.005816949154,69.1038390783094,41.226191456674,19.1017313423443,4.89615414779566,0.000000171090775324956,4.89253887919958,19.094854692682,41.2167265600509,69.0927124243758,99.994117691867,130.89609876042,158.773755664549,180.898230237512,195.103825651517,199.999999825065,195.107481314175,180.905183721245,158.783326314206,130.907349734514,100.005947667118,69.1039634008538,41.2262972142484,19.1018081826703,4.89619454921326,0.000000178822716634386,4.89249849249079,19.0947778648633,41.2166208115613,69.0925881066047,99.9939869739091,130.895974437854,158.773649906924,180.89815339711,195.103785250018,199.999999817247,195.107521700803,180.905260548994,158.783432062646,130.907474052253,100.00607838507,69.1040877234509,41.2264029719325,19.1018850231411,4.89623495079161,0.000000186725543471766,4.8924581059445,19.0947010371828,41.2165150631722,69.0924637888971,99.9938562559513,130.895850115225,158.77354414919,180.898076556573,195.103744848358,199.999999809259,195.107562087268,180.905337376606,158.783537810985,130.90759836994,100.006209103033,69.1042120461063,41.2265087297124,19.1019618637436,4.89627535253247,0.000000194799241626242,4.89241771956073,19.0946242096406,41.2164093148835,69.0923394712316,99.9937255379878,130.895725792549,158.773438391365,180.897999715898,195.103704446536,199.9999998011,195.10760247357,180.905414204079,158.783643559228,130.907722687579,100.006339820985,69.1043363688036,41.2266144875927,19.1020387044909,4.89631575443582,0.000000203043811097814,4.89237733333945,19.0945473822332,41.2163035666952,69.0922151536297,99.9935948200356,130.89560146982,158.773332633429,180.897922875085,195.103664044552,199.99999979277,195.107642859712,180.905491031414,158.783749307361,130.907847005154,100.006470538949,69.1044606915645,41.2267202455734,19.1021155453731,4.8963561565017,0.000000211459251886481,4.89233694728071,19.0944705549708,41.2161978186074,69.0920908360698,99.9934641020721,130.895477147038,158.773226875399,180.897846034134,195.103623642404,199.999999784269,195.107683245688,180.90556785861,158.783855055403,130.907971322688,100.006601256907,69.1045850143729,41.2268260036546,19.1021923863936,4.89639655873006,0.000000220045563992244,4.89229656138447,19.09439372784,41.2160920706155,69.0919665185681,99.99333338412,130.895352824203,158.773121117267,180.897769193044,195.103583240095
};

void main(void){
	int i;

	//ポートの初期設定
	TRISA = 0x0010; // RA4は入力
	CNPUA = 0x0010; // RA4をプルアップ
	ANSELA = 0x0000; // 全てデジタル
	TRISB = KEYSTART | KEYFIRE | KEYUP | KEYDOWN | KEYLEFT | KEYRIGHT;// ボタン接続ポート入力設定
	CNPUBSET=KEYSTART | KEYFIRE | KEYUP | KEYDOWN | KEYLEFT | KEYRIGHT;// プルアップ設定
	ANSELB = 0x0000; // 全てデジタル
	LATACLR=2;// RA1=0（ボタンモード）

	RPB13R=5;//RPB13ピンにOC4を割り当て
	OC4R=0;
	OC4CON=0x000e;// Timer3ベース、Toggleモード
	OC4CONSET=0x8000;//OC4スタート
	T3CON=0x0000;// プリスケーラ1:8
	PR3=256;
	T3CONSET=0x8000;// タイマ3スタート
    
    T4CONbits.SIDL = 0;
    T4CONbits.TCKPS = 3;
    T4CONbits.T32 = 0;
    T4CONbits.TCS = 0;
    TMR4 = 0;
    PR4 = CLOCK_FREQ / 8 / SAMPLING_FREQ;
    T4CONbits.ON = 1;
    
    DmaChnOpen(0, 0, DMA_OPEN_AUTO);

    DmaChnSetEventControl(0, DMA_EV_START_IRQ(_TIMER_4_IRQ));
 
    DmaChnSetTxfer(0, sounddata, (void*)&OC4RS,1020/* sizeof(sounddata)*/, 1, 1);
 
    DmaChnEnable(0);
    
	init_composite(); // ビデオ出力システムの初期化

	while(1){
		for(i=0;i<=36;i++){
			//60分のn秒ウェイト
			drawcount=0;
            while(!drawcount);
            if(DmaChnGetEvFlags(DMA_EV_DST_HALF)){
                
            }
            
            
		}
	}
}